# DexiNed Fine Tuning and Evaluation Repository

This is the repository which contains the adapted DexiNed code from [Soria et al.](https://github.com/xavysp/DexiNed). It adapts some of the base scripts from DexiNed for the purposes of fine tuning and testing. The repository also contains the scripts utilised for evaluation (i.e. the ODS/OIS F-score and AP Scores and the Temporal Consistency).

# Prerequisites:

For the purposes of testing, you will need to fill the checkpoints folder with some of the checkpoints of the fine tuning versions implemented in the dissertation. These can be downloaded from [here](https://drive.google.com/drive/u/2/folders/11jE3KV-cE1BbMNU8t5QQr-rEMr-L9dBt). To test on something, we have also provided the HyperKvasir sequences which were tested on for the Dissertation, in addition to one of the combined test datasets and one of the isolated test datasets (Datasets 1 and 4 . These are all located [here](https://drive.google.com/drive/u/2/folders/1bxryu9bDaOi53Lbky4gLtXXyzJ-iY9HY). These datasets were generated by the data processing pipeline [here](https://github.com/ParhomEsmaeili/Dissertation-Data-Processing).


## Required Packages for the Python Scripts:

* [Python 3.7](https://www.python.org/downloads/release/python-370/g)
* [Pytorch >=1.4](https://pytorch.org/) (Last tested 1.12)
* [OpenCV](https://pypi.org/project/opencv-python/)
* [Matplotlib](https://matplotlib.org/3.1.1/users/installing.html)
* [Kornia](https://kornia.github.io/)
* [Natsort](https://pypi.org/project/natsort/)
* Other package like NumPy, h5py, PIL, json. 

## Required Toolboxes for the MATAB scripts:

For the purposes of computing ODS/OIS F-scores and AP scores you will require a couple of MATLAB toolboxes:

* [Piotr Dollar's Computer Vision MATLAB Toolbox](https://github.com/pdollar/toolbox)
* [Piotr Dollar's Structured Edge Detection Toolbox](https://github.com/pdollar/edges)
* [Image Processing Toolbox](https://uk.mathworks.com/help/images/)
* [Parallel Computing Toolbox](https://uk.mathworks.com/help/parallel-computing/index.html?s_tid=CRUX_lftnav)

The first toolbox should replace the folder named "toolbox" in the "ODS OIS F-Score Scripts" Folder. The second toolbox should replace the folder named "edges" in the "ODS OIS F-Score Scripts" folder. The other two can be downloaded within MATLAB itself.


# Project Architecture

## Inherited Architecture 
First we give an overview of the architecture inherited from [Soria et al.](https://github.com/xavysp/DexiNed#performance) with notes on any adaptations.

```
├── data                        # Adapted image directory for training and testing, the structure for implementing the 
                                # data generated by data processing pipeline is outlined by the datasets which can be downloaded (as mentioned above).
├── utls                        # Tools used in the DexiNed repo (no adaptations)
|   └── image.py                # Miscellaneous tool functions (minimal adaptations)
├── datasets_altered.py         # Adapated code for the tools for dataset managing, this is used inside the main training python file.
├── datasets_test.py            # Adapated code for the tools for dataset managing, this is used inside the main testing python file.
├── losses.py                   # Script containing different loss functions that can be used in training, this is adapted according to the dissertation.
├── main_altered.py             # Adapted main python file with main functions and parameter settings, this is for training.
├── main_test.py                # Adapted main python file with main functions and parameter settings, this is for testing.                               
├── model.py                    # DexiNed class in pytorch, this is relatively untouched, as mentioned in the Dissertation.

```

## Completely New


```
├── ODS OIS F-Score Scripts     #Python tools script which reformats data for the MATLAB script that is used 
                                #for computing ODS/OIS F-scores, in addition to AP scores.
├── Temporal Consistency Scripts #Folder which contains all of the scripts required for the pipelines for the Temporal Consistency Metrics 
```

# How to run the scripts:

## Train 

In order to run the training script, you need to run the following:


    python main_altered.py -specs 
